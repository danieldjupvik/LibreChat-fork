name: Sync Upstream

on:
  schedule:
    - cron: '0 */1 * * *' # Run every hour
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.WORKFLOW_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Add Upstream Remote and Fetch
        run: |
          git remote add upstream https://github.com/danny-avila/LibreChat.git || true
          git fetch upstream

      - name: Try merge
        id: merge
        run: |
          if git merge --no-commit --no-ff upstream/main 2>&1; then
            if [ ! -f .git/MERGE_HEAD ]; then
              echo "No new changes to merge"
              echo "result=no_changes" >> $GITHUB_OUTPUT
            else
              git commit -m "Sync upstream changes"
              git push origin HEAD:main
              echo "Changes were merged successfully"
              echo "result=merged" >> $GITHUB_OUTPUT
            fi
          else
            echo "Merge has conflicts"
            echo "result=conflicts" >> $GITHUB_OUTPUT
            git merge --abort
          fi

      - name: Trigger Build Workflow
        if: steps.merge.outputs.result == 'merged'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.WORKFLOW_TOKEN }}
          event-type: upstream-changes-merged

      - name: Create PR for conflicted changes
        if: steps.merge.outputs.result == 'conflicts'
        run: |
          EXISTING_PR=$(gh pr list --base main --search "Upstream Sync" --state open --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING_PR" ]; then
            echo "Open upstream sync PR already exists: #$EXISTING_PR, skipping"
            exit 0
          fi

          BRANCH="upstream-sync-$(date +%Y%m%d-%H%M)"
          git checkout -b "$BRANCH" upstream/main
          git push origin "$BRANCH"
          gh pr create \
            --title "Upstream Sync (Conflicts to Resolve)" \
            --body "This PR merges upstream changes that conflict with our fork. Please resolve conflicts via the GitHub UI or locally." \
            --base main \
            --head "$BRANCH"
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
